(self.webpackChunkcangulo_github_io=self.webpackChunkcangulo_github_io||[]).push([[5477],{85180:function(e,t,a){"use strict";a.r(t),a.d(t,{frontMatter:function(){return d},contentTitle:function(){return h},metadata:function(){return g},assets:function(){return w},toc:function(){return f},default:function(){return b}});var o=a(83117),n=a(80102),r=(a(67294),a(3905)),s=a(93456),l=a(64888),i=a(46785),c=a(59750),u=a(9741),m=a(38705),p=["components"],d={title:"AWS Control Tower - One year using it",date:new Date("2023-04-09T00:00:00.000Z"),group:"blog",authors:"cangulo",tags:["aws","projects","accounts","setup","costs","aws-control-tower"]},h=void 0,g={permalink:"/blog/aws/control-tower/4-one-year-after",editUrl:"https://github.com/cangulo/cangulo.github.io/blob/main/blog/posts/aws/control-tower/4-one-year-after.mdx",source:"@site/blog/posts/aws/control-tower/4-one-year-after.mdx",title:"AWS Control Tower - One year using it",description:"In this post I'm going to talk about my experience with Control Tower Account Factory for Terraform.",date:"2023-04-09T00:00:00.000Z",formattedDate:"April 9, 2023",tags:[{label:"aws",permalink:"/blog/tags/aws"},{label:"projects",permalink:"/blog/tags/projects"},{label:"accounts",permalink:"/blog/tags/accounts"},{label:"setup",permalink:"/blog/tags/setup"},{label:"costs",permalink:"/blog/tags/costs"},{label:"aws-control-tower",permalink:"/blog/tags/aws-control-tower"}],readingTime:2.405,truncated:!0,authors:[{name:"Carlos Angulo Mascarell",title:"Software Engineer",url:"https://github.com/cangulo",imageURL:"https://github.com/cangulo/cangulo/raw/main/profile_picture_preview_icon.png",key:"cangulo"}],nextItem:{title:"AWS Control Tower - Replacing CodePipelines",permalink:"/blog/aws/control-tower/3-replacing-aws-codepipeline"}},w={authorsImageUrls:[void 0]},f=[{value:"Summary",id:"summary",children:[],level:2},{value:"Is it worth it?",id:"is-it-worth-it",children:[],level:2},{value:"References:",id:"references",children:[{value:"Git Repositories",id:"git-repositories",children:[],level:3}],level:2}],k={toc:f};function b(e){var t=e.components,h=(0,n.Z)(e,p);return(0,r.kt)("wrapper",(0,o.Z)({},k,h,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"In this post I'm going to talk about my experience with Control Tower Account Factory for Terraform."))),(0,r.kt)("h2",{id:"summary"},"Summary"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://developer.hashicorp.com/terraform/tutorials/aws/aws-control-tower-aft#review-aft-components-and-workflow"},"Control Tower Account Factory for Terraform")," is solution aiming to facilitate account creation and governance. You can use it to define what out-of-the-box resources your accounts will have, as well as, add new resources to all the enrolled accounts. It is based on the next workflow:"),(0,r.kt)(s.Mermaid,{chart:"graph LR\n  account_request[Account Creation Request]\n  global_cus[Apply Global Customization]\n  spec_cus[Apply Account Customization]\n  account_request--\x3eglobal_cus\n  global_cus--\x3espec_cus",mdxType:"Mermaid"}),(0,r.kt)("i",null,(0,r.kt)(i.CaptionDocusaurus,{label:"(simplified) Full schema here",linkIsRelative:!1,link:"https://developer.hashicorp.com/terraform/tutorials/aws/aws-control-tower-aft#review-aft-components-and-workflow",mdxType:"CaptionDocusaurus"})),(0,r.kt)("p",null,"Let's say we want to create an account, here is an example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-hcl"},'module "arepabank" {\n  source = "./modules/aft-account-request"\n\n  control_tower_parameters = {\n    AccountEmail              = "arepabank-dev-aa50424c@outlook.com"\n    AccountName               = "arepabank-dev"\n  }\n\n  custom_fields                = {\n    client        = "arepa"\n    env           = "dev"\n  }\n  account_customizations_name  = "dev"  # you can use this to group account by stage or client\n}\n')),(0,r.kt)("p",null,"Then, depending what you have in the global customization repo (example ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/hashicorp/learn-terraform-aft-global-customizations"},"here"),") you can define resources to be created in ALL the accounts. A use case is to define a role in all the accounts (deployment role), this one can only be assumed by one IAM user (deployment user)."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-hcl",metastring:"file=./resources/3/global-customizations/iam.roles.tf",file:"./resources/3/global-customizations/iam.roles.tf"},'resource "aws_iam_role" "iac_deployer" {\n  name                = "iac-deployer-${local.account_name}"\n  path                = "/deployments/"\n  assume_role_policy  = data.aws_iam_policy_document.allow_shared_users_to_assume_role.json\n  managed_policy_arns = [data.aws_iam_policy.admin.arn]\n}\n\ndata "aws_iam_policy" "admin" {\n  name = "AdministratorAccess"\n}\n\ndata "aws_iam_policy_document" "allow_shared_users_to_assume_role" {\n  statement {\n    actions = ["sts:AssumeRole"]\n    principals {\n      type        = "AWS"\n      identifiers = [local.shared_iac_deployer_user]\n    }\n  }\n}\n\nlocals {\n  shared_iac_deployer_user = "arn:aws:iam::2146903:user/deployments/iac-deployer-shared"\n}\n')),(0,r.kt)("i",null,(0,r.kt)(i.CaptionDocusaurus,{label:"Terraform Code in the Global Customization",linkIsRelative:!0,link:"posts/aws/control-tower/resources/3/global-customizations/iam.roles.tf",mdxType:"CaptionDocusaurus"})),(0,r.kt)("p",null,"Based on the account customization repository (example ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/hashicorp/learn-terraform-aft-account-customizations"},"here"),") and folder named as the ",(0,r.kt)("inlineCode",{parentName:"p"},"account_customizations_name")," parameter, only the resources defined there will be created. We can use this to create different resources per stage, for example different ec2 instances:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"dev/\n  ec2.micro.tf\ntst/\n  ec2.small.tf\nacc/\n  ec2.medium.tf\nprd/\n  ec2.large.tf\n")),(0,r.kt)("p",null,"Each ec2.*.tf file will contain different configuration. "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-hcl"},'resource "aws_instance" "web" {\n  ami           = data.aws_ami.ubuntu.id\n  instance_type = "t3.micro"\n}\n')),(0,r.kt)("i",null,(0,r.kt)(i.CaptionDocusaurus,{label:"ec2.t3.micro.tf",mdxType:"CaptionDocusaurus"})),(0,r.kt)("h2",{id:"is-it-worth-it"},"Is it worth it?"),(0,r.kt)("p",null,"For personal projects and ephemeral workloads: No. Let me list the reasons"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"There are fixed costs, no matter if you enroll accounts or not. Next are the main ones:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"VPC Endpoints. In my first two post I had to fork the official repo and add flags to disable them."),(0,r.kt)("li",{parentName:"ul"},"KMS keys. I also tried to disable it but major changes were required because it was highly coupled with other resources. "),(0,r.kt)("li",{parentName:"ul"},"Log Archive account costs: Only S3, KMS and AWS Config services. Less than the previous two, 4$ maximum. "))),(0,r.kt)("li",{parentName:"ul"},"AWS CodePipelines, CodeBuild and VPC costs are too high for personal projects. There is a ",(0,r.kt)("inlineCode",{parentName:"li"},"customizations-pipeline")," for each account. This means if you want to update all accounts, all pipelines should be executed. I had 12 accounts enrolled and I paid more than 60$ one month. The same work done in the pipelines could be in GitHub workflows as I did in my ",(0,r.kt)("a",{parentName:"li",href:"/blog/aws/control-tower/3-replacing-aws-codepipeline"},"previous post"))),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"AWS Costs - worst months ",src:a(12799).Z})),(0,r.kt)("p",null,"For my personal projects I'm going to look for a custom solution with cost based on usage. "),(0,r.kt)("h2",{id:"references"},"References:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/controltower/latest/userguide/getting-started-with-control-tower.html"},"Starting with Control Tower")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/controltower/latest/userguide/guardrails.html"},"control tower user guide"))),(0,r.kt)("h3",{id:"git-repositories"},"Git Repositories"),(0,r.kt)(m.ZP,{mdxType:"AboutMe"}),(0,r.kt)(u.ZP,{mdxType:"FullExperienceLink"}),(0,r.kt)(c.ZP,{mdxType:"Contact"}),(0,r.kt)(i.ShareDocusaurus,{preSlug:d.group,slug:d.slug,title:d.title,tags:d.tags,mdxType:"ShareDocusaurus"}),(0,r.kt)(l.Z,{mdxType:"Comments"}))}b.isMDXComponent=!0},64888:function(e,t,a){"use strict";var o=a(67294),n=a(84610),r=a(52263);t.Z=function(){var e=(0,r.default)().siteConfig,t=parseInt(e.customFields.hyvorTalkSiteId);return o.createElement("section",null,o.createElement("h2",null,"Comments"),o.createElement(n.Z.Embed,{loadMode:"scroll",websiteId:t}))}},11748:function(e,t,a){var o={"./locale":89234,"./locale.js":89234};function n(e){var t=r(e);return a(t)}function r(e){if(!a.o(o,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return o[e]}n.keys=function(){return Object.keys(o)},n.resolve=r,e.exports=n,n.id=11748},12799:function(e,t,a){"use strict";t.Z=a.p+"assets/images/aws-costs-worst-months-925424b26dd62200da3219d38d74b43b.png"}}]);