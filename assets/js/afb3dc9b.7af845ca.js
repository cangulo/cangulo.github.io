"use strict";(self.webpackChunkcangulo_github_io=self.webpackChunkcangulo_github_io||[]).push([[8317],{30455:function(t,e,a){a.r(e),a.d(e,{frontMatter:function(){return m},contentTitle:function(){return d},metadata:function(){return f},assets:function(){return k},toc:function(){return _},default:function(){return g}});var n=a(83117),o=a(80102),l=(a(67294),a(3905)),i=a(64888),r=a(46785),s=a(26684),c=a(93511),p=a(84964),u=["components"],m={title:"AWS Control Tower - Replacing CodePipelines",date:new Date("2023-04-08T00:00:00.000Z"),group:"blog",authors:"cangulo",tags:["aws","projects","accounts","setup","costs","aws-control-tower"]},d=void 0,f={permalink:"/blog/aws/control-tower/3-replacing-aws-codepipeline",editUrl:"https://github.com/cangulo/cangulo.github.io/blob/main/blog/posts/aws/control-tower/3-replacing-aws-codepipeline.mdx",source:"@site/blog/posts/aws/control-tower/3-replacing-aws-codepipeline.mdx",title:"AWS Control Tower - Replacing CodePipelines",description:"In this post I'm going to explain how I migrate the Control Tower AFT CodePipelines to GitHub workflows.",date:"2023-04-08T00:00:00.000Z",formattedDate:"April 8, 2023",tags:[{label:"aws",permalink:"/blog/tags/aws"},{label:"projects",permalink:"/blog/tags/projects"},{label:"accounts",permalink:"/blog/tags/accounts"},{label:"setup",permalink:"/blog/tags/setup"},{label:"costs",permalink:"/blog/tags/costs"},{label:"aws-control-tower",permalink:"/blog/tags/aws-control-tower"}],readingTime:2.43,truncated:!0,authors:[{name:"Carlos Angulo Mascarell",title:"Software Engineer",url:"https://github.com/cangulo",imageURL:"https://github.com/cangulo/cangulo/raw/main/profile_picture_preview_icon.png",key:"cangulo"}],prevItem:{title:"AWS Control Tower - One year using it",permalink:"/blog/aws/control-tower/4-one-year-after"},nextItem:{title:"AWS Control Tower - Reducing Cost 2",permalink:"/blog/aws/control-tower/2-disable-config-in-aft-account"}},k={authorsImageUrls:[void 0]},_=[{value:"wait, why?",id:"wait-why",children:[{value:"Pipelines",id:"pipelines",children:[],level:3},{value:"Migrating to GH workflows",id:"migrating-to-gh-workflows",children:[],level:3}],level:2}],b={toc:_};function g(t){var e=t.components,d=(0,o.Z)(t,u);return(0,l.kt)("wrapper",(0,n.Z)({},b,d,{components:e,mdxType:"MDXLayout"}),(0,l.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"In this post I'm going to explain how I migrate the Control Tower AFT CodePipelines to GitHub workflows. "))),(0,l.kt)("h2",{id:"wait-why"},"wait, why?"),(0,l.kt)("p",null,"Simply, saving costs. Next are the monthly costs for updating 12 AWS accounts. "),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"AWS Costs - worst months",src:a(42881).Z})),(0,l.kt)("div",{style:{display:"flex",justifyContent:"center"}},(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Service"),(0,l.kt)("th",{parentName:"tr",align:null},"Service total"),(0,l.kt)("th",{parentName:"tr",align:null},"December 2022"),(0,l.kt)("th",{parentName:"tr",align:null},"January 2023"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"VPC costs"),(0,l.kt)("td",{parentName:"tr",align:null},"$31.86"),(0,l.kt)("td",{parentName:"tr",align:null},"$30.36"),(0,l.kt)("td",{parentName:"tr",align:null},"$1.50")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"CodePipeline costs"),(0,l.kt)("td",{parentName:"tr",align:null},"$12.00"),(0,l.kt)("td",{parentName:"tr",align:null},"$2.00"),(0,l.kt)("td",{parentName:"tr",align:null},"$10.00")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"Key Management Service costs"),(0,l.kt)("td",{parentName:"tr",align:null},"$11.98"),(0,l.kt)("td",{parentName:"tr",align:null},"$5.99"),(0,l.kt)("td",{parentName:"tr",align:null},"$5.99")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"CodeBuild costs"),(0,l.kt)("td",{parentName:"tr",align:null},"$5.49"),(0,l.kt)("td",{parentName:"tr",align:null},"$3.54"),(0,l.kt)("td",{parentName:"tr",align:null},"$1.95"))))),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"VPC Costs: I described in my previous post how to reduce it through a custom flag."),(0,l.kt)("li",{parentName:"ul"},"Code Pipeline and Codebuild costs: The main cost here is related to pipelines executions. We will dive into in the next section."),(0,l.kt)("li",{parentName:"ul"},"KMS: Control Tower for AFT Cost for using the secrets created with Control Tower AFT")),(0,l.kt)("h3",{id:"pipelines"},"Pipelines"),(0,l.kt)("p",null,"Account customization has two type: "),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"aft-global-customization in the repository ",(0,l.kt)("a",{parentName:"li",href:"https://github.com/hashicorp/learn-terraform-aft-account-customizations"},"learn-terraform-aft-account-customizations"),"  "),(0,l.kt)("li",{parentName:"ul"},"aft-account-customization in the repository ",(0,l.kt)("a",{parentName:"li",href:"https://github.com/hashicorp/learn-terraform-aft-global-customizations"},"learn-terraform-aft-global-customizations"),"  ")),(0,l.kt)("p",null,"Both are in the same CodePipeline model ",(0,l.kt)("inlineCode",{parentName:"p"},"{ACCOUNT_ID}-customizations-pipeline"),":"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"AWS Costs - example ",src:a(665).Z})),(0,l.kt)("p",null,"There is one pipeline replica for each AWS account:"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"AWS Costs - list ",src:a(64923).Z})),(0,l.kt)("p",null,"So, for updating all the accounts, all the pipelines should be executed. "),(0,l.kt)("h3",{id:"migrating-to-gh-workflows"},"Migrating to GH workflows"),(0,l.kt)("p",null,"Let me first set the scope: I want to reduce the CodePipeline cost by executing GH workflows instead. "),(0,l.kt)("p",null,"My initial approach is to create GH workflows in the ",(0,l.kt)("inlineCode",{parentName:"p"},"global-customization")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"account-customization")," repositories to apply customizations to any account. This will work for created account, but if I create a new one that will still go through the CodePipeline. "),(0,l.kt)("p",null,"Okey, let's start:"),(0,l.kt)("p",null,"First, let me list the pipelines specs:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/aws-ia/terraform-aws-control_tower_account_factory/blob/60ee77b6a90e4bc6a96a60c8d8105d71ba5d3543/modules/aft-customizations/buildspecs/aft-account-customizations-terraform.yml"},"aft-account-customizations")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/aws-ia/terraform-aws-control_tower_account_factory/blob/60ee77b6a90e4bc6a96a60c8d8105d71ba5d3543/modules/aft-customizations/buildspecs/aft-global-customizations-terraform.yml"},"aft-global-customizations"))),(0,l.kt)("p",null,"Both share a common structure:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/aws-ia/terraform-aws-control_tower_account_factory/blob/60ee77b6a90e4bc6a96a60c8d8105d71ba5d3543/modules/aft-customizations/buildspecs/aft-global-customizations-terraform.yml#L7"},"install"),": setup the environment variables for the execution and install the dependencies"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/aws-ia/terraform-aws-control_tower_account_factory/blob/60ee77b6a90e4bc6a96a60c8d8105d71ba5d3543/modules/aft-customizations/buildspecs/aft-global-customizations-terraform.yml#L63"},"pre_build"),": execute a python script"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/aws-ia/terraform-aws-control_tower_account_factory/blob/60ee77b6a90e4bc6a96a60c8d8105d71ba5d3543/modules/aft-customizations/buildspecs/aft-global-customizations-terraform.yml#L71"},"build"),":  ",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"build ",(0,l.kt)("inlineCode",{parentName:"li"},"backend.tf")," and ",(0,l.kt)("inlineCode",{parentName:"li"},"aft-providers.tf")," from the templates ",(0,l.kt)("inlineCode",{parentName:"li"},"backend.jinja")," and ",(0,l.kt)("inlineCode",{parentName:"li"},"aft-providers.jinja"),". jinja is language that combined with python simplify files templates filling, in this case, help us build those terraform files dynamically for each account."),(0,l.kt)("li",{parentName:"ul"},"terraform init"),(0,l.kt)("li",{parentName:"ul"},"terraform apply"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/aws-ia/terraform-aws-control_tower_account_factory/blob/60ee77b6a90e4bc6a96a60c8d8105d71ba5d3543/modules/aft-customizations/buildspecs/aft-global-customizations-terraform.yml#L115"},"post_build"),": execute a python script, useful for a post clean up actions")),(0,l.kt)("p",null,"In order to keep it simple, I'm going to skip the pre_build and post_build part. Let's start:"),(0,l.kt)("p",null,"First, I want to map all the accounts detail into JSON files as:"),(0,l.kt)("p",null,"accounts/arepabank-dev.json"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "account_id": "114628476372",\n    "env": "dev"\n}\n')),(0,l.kt)("p",null,"If we list those files and provide the to the ",(0,l.kt)("inlineCode",{parentName:"p"},"strategy.matrix")," we can update multiple accounts at the same time. "),(0,l.kt)("p",null,"Next is the main workflow code:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yml",metastring:"file=./resources/3/global-customizations/.github/workflows/shared-tf-plan.yml",file:"./resources/3/global-customizations/.github/workflows/shared-tf-plan.yml"},'on:\n  workflow_call:\n    inputs:\n      accounts:\n        required: true\n        type: string\n      apply:\n        required: false\n        type: boolean\n        default: false\nenv:\n  # use GH secrets to store sensitive credentials\n  AFT_ACCOUNT_ID: ${{ secrets.AFT_ACCOUNT_ID }}\n  AWS_ACCESS_KEY_ID: ${{ secrets.AFT_ROOT_EXECUTOR_AK }}\n  AWS_SECRET_ACCESS_KEY: ${{ secrets.AFT_ROOT_EXECUTOR_SK }}\n  AWS_DEFAULT_REGION: ${{ secrets.AFT_ROOT_EXECUTOR_REGION }}\n  TF_STATE_BACKEND_S3_KMS_KEY_ID: ${{ secrets.TF_STATE_S3_BUCKET_KMS_ID }}\n\njobs:\n  deployment:\n    name: ${{ matrix.account }}\n    runs-on: ubuntu-latest\n    environment: ${{ inputs.apply == true && matrix.account }}\n    strategy:\n      fail-fast: false\n      matrix:\n        account: ${{ fromJSON(inputs.accounts) }}  # accounts is an array with JSON files names\n    steps:\n    - name: Checkout\n      uses: actions/checkout@v3\n    - name: setup account properties\n      env:\n        ACCOUNT_FILE: "accounts/${{ matrix.account }}.json"\n      run: |\n        ACCOUNT_ID=$(jq \'.account_id\' $ACCOUNT_FILE -r)\n        ACCOUNT_ENV=$(jq \'.env\' $ACCOUNT_FILE -r)\n\n        # mapping ENV VARS from CodePipeline spec\n        echo "EXECUTION_TIMESTAMP=$(date \'+%Y-%m-%d %H:%M:%S\')" >> $GITHUB_ENV\n        echo "TF_DISTRIBUTION_TYPE=oss" >> $GITHUB_ENV\n        echo "AWS_BACKEND_REGION=$AWS_DEFAULT_REGION" >> $GITHUB_ENV\n        echo "AWS_BACKEND_BUCKET=aft-backend-$AFT_ACCOUNT_ID-primary-region" >> $GITHUB_ENV\n        echo "AWS_BACKEND_KEY=$ACCOUNT_ID-aft-global-customizations/terraform.tfstate" >> $GITHUB_ENV\n        echo "AWS_BACKEND_DYNAMODB_TABLE=aft-backend-$AFT_ACCOUNT_ID" >> $GITHUB_ENV\n        echo "AWS_BACKEND_KMS_KEY_ID=$TF_STATE_BACKEND_S3_KMS_KEY_ID" >> $GITHUB_ENV\n        \n        # BE SURE credentials have permission on the bucket\n        echo "AWS_BACKEND_ROLE_ARN=" >> $GITHUB_ENV\n\n        # BE SURE credentials can assume this role / or create a role\n        echo "AWS_PROVIDER_ROLE_ARN=arn:aws:iam::$ACCOUNT_ID:role/AWSAFTExecution" >> $GITHUB_ENV\n        \n        # file paths\n        echo "AWS_BACKEND_PATH=terraform/backend.jinja" >> $GITHUB_ENV\n        echo "AWS_PROVIDER_PATH=terraform/aft-providers.jinja" >> $GITHUB_ENV\n\n    - name: build aft-providers.tf and backend.tf\n      run: |\n        pip install Jinja2\n        ./scripts/aft-providers-builder.py\n        cat "terraform/aft-providers.tf"\n        ./scripts/backend-builder.py\n        cat "terraform/backend.tf"\n\n    - name: Terraform Plan\n      id: tf-plan\n      working-directory: terraform\n      run: |\n        TF_PLAN_PATH="$GITHUB_WORKSPACE/accounts/${{ matrix.account }}.tfplan"\n        echo "TF_PLAN_PATH=$TF_PLAN_PATH" >> $GITHUB_ENV\n        terraform init\n        terraform plan -out=$TF_PLAN_PATH\n\n    - name: terraform apply\n      if: ${{ inputs.apply == true }}\n      working-directory: terraform\n      run: |\n        terraform apply $TF_PLAN_PATH \n')),(0,l.kt)("p",null,"The python code to build the .jinja file is:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yml",metastring:"file=./resources/3/global-customizations/scripts/backend-builder.py",file:"./resources/3/global-customizations/scripts/backend-builder.py"},"#!/usr/bin/python3\n\nimport os\nfrom jinja2 import Environment, FileSystemLoader\n\n\nbackend_path=os.getenv('AWS_BACKEND_PATH')\ntimestamp=os.getenv('EXECUTION_TIMESTAMP')\ntf_distribution_type=os.getenv('TF_DISTRIBUTION_TYPE')\nbackend_region=os.getenv('AWS_BACKEND_REGION')\nbucket=os.getenv('AWS_BACKEND_BUCKET')\nkey=os.getenv('AWS_BACKEND_KEY')\ndynamodb_table=os.getenv('AWS_BACKEND_DYNAMODB_TABLE')\nkms_key_id=os.getenv('AWS_BACKEND_KMS_KEY_ID')\naft_admin_role_arn=os.getenv('AWS_BACKEND_ROLE_ARN')\n\nfile_loader = FileSystemLoader('.')\nenv = Environment(loader=file_loader)\n\ntemplate = env.get_template(backend_path)\n\noutput_content = template.render(\n    timestamp=timestamp,\n    tf_distribution_type=tf_distribution_type,\n    region=backend_region,\n    bucket=bucket,\n    key=key,\n    dynamodb_table=dynamodb_table,\n    kms_key_id=kms_key_id,\n    aft_admin_role_arn=aft_admin_role_arn\n)\noutput_filename = backend_path.replace(\".jinja\",\".tf\")\n\n# to save the results\nwith open(output_filename, \"w\") as fh:\n    fh.write(output_content)\n")),(0,l.kt)("p",null,"You can check the other workflows and scripts to see how I integrated this in a PR workflow:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{target:"_blank",href:a(56217).Z},"1-pr.yml")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{target:"_blank",href:a(43641).Z},"2-deploy-main.yml")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{target:"_blank",href:a(35850).Z},"shared-tf-plan.yml")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{target:"_blank",href:a(71231).Z},"shared-get-workspaces.yml")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{target:"_blank",href:a(92398).Z},"backend-builder.py")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{target:"_blank",href:a(62965).Z},"aft-providers-builder.py"))),(0,l.kt)(p.ZP,{mdxType:"AboutMe"}),(0,l.kt)(c.ZP,{mdxType:"FullExperienceLink"}),(0,l.kt)(s.ZP,{mdxType:"Contact"}),(0,l.kt)(r.ShareDocusaurus,{preSlug:m.group,slug:m.slug,title:m.title,tags:m.tags,mdxType:"ShareDocusaurus"}),(0,l.kt)(i.Z,{mdxType:"Comments"}))}g.isMDXComponent=!0},64888:function(t,e,a){var n=a(67294),o=a(76243),l=a(52263);e.Z=function(){var t=(0,l.default)().siteConfig,e=parseInt(t.customFields.hyvorTalkSiteId);return n.createElement("section",null,n.createElement("h2",null,"Comments"),n.createElement(o.HW,{loadMode:"scroll","website-id":e,"page-id":""}))}},56217:function(t,e,a){e.Z=a.p+"assets/files/1-pr-e77a999858f04b784bbd8631c89b211d.yml"},43641:function(t,e,a){e.Z=a.p+"assets/files/2-deploy-main-f0d40407c75e49bbcf876517768a066a.yml"},71231:function(t,e,a){e.Z=a.p+"assets/files/shared-get-workspaces-1fb852bb78ad1e7d6953f0ce4157e98e.yml"},35850:function(t,e,a){e.Z=a.p+"assets/files/shared-tf-plan-04995cb5b86db23129e20f2bf80e4bed.yml"},62965:function(t,e,a){e.Z=a.p+"assets/files/aft-providers-builder-5d8c80d08f6102814c177ff4b1498667.py"},92398:function(t,e,a){e.Z=a.p+"assets/files/backend-builder-c94c14a659ff4e897922aa396bc2a1b3.py"},42881:function(t,e,a){e.Z=a.p+"assets/images/codepipeline-costs-0b519968c7ae36c637cbc3804c3b76b5.png"},665:function(t,e,a){e.Z=a.p+"assets/images/codepipeline-example-429dff71dc89a097788f439e18b7575a.png"},64923:function(t,e,a){e.Z=a.p+"assets/images/codepipeline-list-1ed313d4ae3de664eb1c0f5b2f7cb038.png"}}]);